<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-English/DesignImplementation/RLVRPipeline">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">RLVR Pipeline | ROLL</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://alibaba.github.io/ROLL/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://alibaba.github.io/ROLL/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://alibaba.github.io/ROLL/docs/English/DesignImplementation/RLVRPipeline"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RLVR Pipeline | ROLL"><meta data-rh="true" name="description" content="RLVR Pipeline (Reinforcement Learning with Verifiable Rewards Pipeline) is a core component in the ROLL framework, specifically designed as an efficient distributed training pipeline for large language model reinforcement learning. Through virtual reward mechanisms, this pipeline can significantly improve LLM performance on key tasks such as complex reasoning, code generation, and mathematical calculations."><meta data-rh="true" property="og:description" content="RLVR Pipeline (Reinforcement Learning with Verifiable Rewards Pipeline) is a core component in the ROLL framework, specifically designed as an efficient distributed training pipeline for large language model reinforcement learning. Through virtual reward mechanisms, this pipeline can significantly improve LLM performance on key tasks such as complex reasoning, code generation, and mathematical calculations."><link data-rh="true" rel="icon" href="/ROLL/img/logo.png"><link data-rh="true" rel="canonical" href="https://alibaba.github.io/ROLL/docs/English/DesignImplementation/RLVRPipeline"><link data-rh="true" rel="alternate" href="https://alibaba.github.io/ROLL/docs/English/DesignImplementation/RLVRPipeline" hreflang="en"><link data-rh="true" rel="alternate" href="https://alibaba.github.io/ROLL/docs/English/DesignImplementation/RLVRPipeline" hreflang="x-default"><link rel="stylesheet" href="/ROLL/assets/css/styles.ee92b8a2.css">
<link rel="preload" href="/ROLL/assets/js/runtime~main.9ad68e1a.js" as="script">
<link rel="preload" href="/ROLL/assets/js/main.8457def1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ROLL/"><div class="navbar__logo"><img src="/ROLL/img/logo.png" alt="ROLL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/ROLL/img/logo.png" alt="ROLL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ROLL</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/ROLL/docs/English/DesignImplementation/AgenticPipeline">文档</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/alibaba/ROLL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/ROLL/docs/English/DesignImplementation/AgenticPipeline">English</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ROLL/docs/English/DesignImplementation/AgenticPipeline">DesignImplementation</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ROLL/docs/English/DesignImplementation/AgenticPipeline">AgenticPipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ROLL/docs/English/DesignImplementation/RLVRPipeline">RLVR Pipeline</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ROLL/docs/English/DevelopmentGuide/support_new_models_en">DevelopmentGuide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ROLL/docs/English/QuickStart/config_guide">QuickStart</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ROLL/docs/English/UserGuide/agentic/Tool_Use">UserGuide</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ROLL/docs/English/start">start</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ROLL/docs/">index</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ROLL/docs/简体中文/使用指南/agentic/Tool_Use">简体中文</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ROLL/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">English</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">DesignImplementation</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RLVR Pipeline</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>RLVR Pipeline</h1><p>RLVR Pipeline (Reinforcement Learning with Verifiable Rewards Pipeline) is a core component in the ROLL framework, specifically designed as an efficient distributed training pipeline for large language model reinforcement learning. Through virtual reward mechanisms, this pipeline can significantly improve LLM performance on key tasks such as complex reasoning, code generation, and mathematical calculations.</p><p>In the field of artificial intelligence, Reinforcement Learning with Verifiable Rewards (RLVR) is an innovative training method that uses verifiable, rule-based reward functions to provide models with clear binary feedback (1 for correct, 0 for incorrect), thereby optimizing their performance. Unlike traditional Reinforcement Learning from Human Feedback (RLHF), RLVR avoids dependence on subjective human evaluation or complex reward models, making the training process more transparent and efficient. This method is particularly suitable for tasks with clear correctness standards, such as mathematical reasoning and code generation.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-advantages">Core Advantages<a href="#core-advantages" class="hash-link" aria-label="Direct link to Core Advantages" title="Direct link to Core Advantages">​</a></h2><ul><li><strong>Diverse Task Support</strong>: RLVR Pipeline has built-in support for multiple task types, including mathematical reasoning, code generation, LLM judgment, and instruction following, each equipped with dedicated reward evaluation mechanisms. <code>MathRuleRewardWorker</code> automatically evaluates the correctness of mathematical problems, <code>CodeSandboxRewardWorker</code> verifies program correctness through code execution, and <code>LLMJudgeRewardWorker</code> performs quality assessment of open-ended questions. The flexible extension interface design makes integration of new task types simple and direct.</li><li><strong>Multi-Task Joint Training</strong>: Supports simultaneous optimization across domains, achieving collaborative improvement of models in multiple fields such as mathematics, programming, and general reasoning. Precise control of data sampling ratios for each domain through <code>domain_interleave_probs</code>, with independent reward processing strategies and weight coefficients configurable for each domain, avoiding the capability limitations that single-task training might cause.</li><li><strong>Algorithm-Friendly Reinforcement Learning Framework</strong>: Provides multiple reinforcement learning strategy options, supporting various cutting-edge algorithms such as PPO, GRPO, Reinforce, and TOPR. Rich reward processing strategies include reward normalization, reward clipping, reward scaling, etc., multiple advantage estimation methods, and flexible loss function configuration, enabling researchers to easily experiment with different algorithm combinations.</li><li><strong>Comprehensive Performance Monitoring</strong>: A fine-grained metrics tracking system provides comprehensive training process monitoring, tracking performance metrics at both group and batch levels, statistically displaying performance metrics by task domain, as well as system metrics such as GPU usage, memory occupation, and training throughput, providing comprehensive visualization and analysis functions for the model training process<strong>.</strong></li><li><strong>Efficient Distributed Computing</strong>: A distributed training architecture based on the <a href="https://www.ray.io/" target="_blank" rel="noopener noreferrer">Ray</a> framework, intelligently allocating different types of worker nodes through heterogeneous task scheduling, dynamically managing resources by automatically adjusting resource allocation based on task load, executing generation, reward calculation, and model update phases in parallel, and featuring automatic fault recovery mechanisms, fully utilizing the computing power of modern GPU clusters.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="main-attributes">Main Attributes<a href="#main-attributes" class="hash-link" aria-label="Direct link to Main Attributes" title="Direct link to Main Attributes">​</a></h2><h4 class="anchor anchorWithStickyNavbar_LWe7" id="core-configuration">Core Configuration<a href="#core-configuration" class="hash-link" aria-label="Direct link to Core Configuration" title="Direct link to Core Configuration">​</a></h4><ul><li>pipeline_config: The core configuration object of the RLVRPipeline class, of type RLVRConfig, containing all configuration parameters for the entire reinforcement learning training pipeline.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="actor-critic-architecture-clusters">Actor-Critic Architecture Clusters<a href="#actor-critic-architecture-clusters" class="hash-link" aria-label="Direct link to Actor-Critic Architecture Clusters" title="Direct link to Actor-Critic Architecture Clusters">​</a></h4><ul><li><p>actor_train: The policy network training cluster in RLVRPipeline, responsible for executing the core training logic of the PPO algorithm.</p></li><li><p>actor_infer: The policy network inference cluster in RLVRPipeline, responsible for generating responses.</p></li><li><p>reference: The reference model cluster in RLVRPipeline, serving as a baseline model in the policy optimization process for calculating KL divergence.</p></li><li><p>critic (optional): Estimates the state value function (only used in GAE mode)</p></li><li><p>reward: The policy network reward cluster in RLVRPipeline, responsible for calculating reward scores for generated responses, supporting multi-domain and multi-type reward calculation:</p><ul><li>Mathematical rule rewards (<code>MathRuleRewardWorker</code>): Evaluating the correctness of mathematical reasoning</li><li>Code sandbox rewards (<code>CodeSandboxRewardWorker</code>): Evaluating code by executing it and verifying its output</li><li>LLM judgment rewards (<code>LLMJudgeRewardWorker</code>): Using another LLM as an evaluator to assess the quality of generated answers</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-related-attributes">Data-Related Attributes<a href="#data-related-attributes" class="hash-link" aria-label="Direct link to Data-Related Attributes" title="Direct link to Data-Related Attributes">​</a></h4><ul><li>domain_datasets: <code>Dict[str, datasets.Dataset]</code>, a dictionary of training datasets grouped by domain</li><li>val_dataset: Validation dataset</li><li>domain_batch_size: Batch size configuration for each domain, allocating batch sizes for each domain according to <code>domain_interleave_probs</code></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="scheduler-attributes">Scheduler Attributes<a href="#scheduler-attributes" class="hash-link" aria-label="Direct link to Scheduler Attributes" title="Direct link to Scheduler Attributes">​</a></h4><ul><li>generate_schedulers: <code>Dict[str, DynamicSamplingScheduler]</code>, dynamic sampling schedulers for each domain</li><li>val_generate_scheduler: Generation scheduler for the validation phase</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="controllers-and-auxiliary-tools">Controllers and Auxiliary Tools<a href="#controllers-and-auxiliary-tools" class="hash-link" aria-label="Direct link to Controllers and Auxiliary Tools" title="Direct link to Controllers and Auxiliary Tools">​</a></h4><ul><li>kl_ctrl: Adaptively adjusts the KL penalty coefficient to prevent the policy update from deviating too far from the reference policy</li><li>tokenizer: Handles text encoding and decoding</li><li>running: Calculates and maintains runtime statistics</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-process">Core Process<a href="#core-process" class="hash-link" aria-label="Direct link to Core Process" title="Direct link to Core Process">​</a></h2><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Initialize TPS timer </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> metrics manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> global_step </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">max_steps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 1. Model state management</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Update model parameters </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">actor_train </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> actor_infer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 2. Evaluation phase (executed every eval_steps)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> val_dataset </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> global_step </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> eval_steps </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Validation environment rollout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_dataset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Calculate evaluation metrics </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">accuracy statistics grouped by tag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 3. Training data collection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Start inference server </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> reward cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> domain </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> domains</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            domain_batches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">domain</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_batch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">domain_batch_size</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">domain</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Merge </span><span class="token builtin">all</span><span class="token plain"> domain batches</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Stop inference server </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> reward cluster    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 4. Calculate key probabilities and values  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ref_log_probs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Reference model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate log probabilities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        old_log_probs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Actor_train model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate log probabilities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> using GAE estimator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Critic model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate value function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 5. Reward processing and advantage calculation (processed by domain grouping)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> domain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> domain_batch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group_by</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;domain&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Get sample_level_mask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Normalize reward scores by group </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running_moments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Apply KL penalty </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kl_controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Calculate token</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">level rewards</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Calculate advantage function </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GAE </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> other methods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Re</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">merge </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> sort batches</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 6. Model training</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> using GAE estimator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Critic model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">training step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> global_step </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> critic_warmup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Actor model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">training step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 7. Record and save</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Update TPS metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Record training metrics </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grouped by domain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Save checkpoints </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> scheduler state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Print sample logs </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">every logging_steps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Record to tracker     </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="model_update">model_update<a href="#model_update" class="hash-link" aria-label="Direct link to model_update" title="Direct link to model_update">​</a></h4><p>Synchronize training model parameters to the inference model to ensure that the inference model used for generating rollout data uses the latest training parameters. In the PPO algorithm, the training model actor_train is responsible for parameter updates and gradient calculations, while the inference model actor_infer is responsible for generating rollout data. To ensure training consistency, the inference model needs to periodically synchronize the latest training data, so that the generated rollout data can reflect the true performance of the current policy.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Initialize phase to set synchronization pairs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_model_update_pair</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actor_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tgt_cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actor_infer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      frequency</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipeline_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actor_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_update_frequency</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Execute synchronization in training loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_update_metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">global_step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics_mgr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_metrics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_update_metrics</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="step_generate">step_generate<a href="#step_generate" class="hash-link" aria-label="Direct link to step_generate" title="Direct link to step_generate">​</a></h4><p>Training data collection adopts a multi-domain parallel generation architecture. Start the inference server and reward calculation cluster, then generate corresponding size data batches in parallel for each training domain according to the configuration ratio. Each domain samples prompts from its respective dataset through an independent scheduler and generates responses using the actor model, while simultaneously calculating corresponding reward scores. Finally, all domain batches are merged into a complete training batch, and inference resources are cleaned up, completing one round of training data collection.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Start batch generation in parallel for each domain</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> domain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scheduler </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">generate_schedulers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remote</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Collect results from all domains</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">domain_batches </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> domain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scheduler_ref </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> scheduler_refs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domain_batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scheduler_ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rpc_timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domain_batches</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">domain</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> domain_batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Merge all domain batches</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">generate_output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DataProto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">domain_batch </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> domain_batch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> domain_batches</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cal_ref_log_probs">cal_ref_log_probs<a href="#cal_ref_log_probs" class="hash-link" aria-label="Direct link to cal_ref_log_probs" title="Direct link to cal_ref_log_probs">​</a></h4><p><code>reference.compute_log_probs</code> calculates the log probabilities of the reference model for the current batch data. Used for subsequent KL divergence penalty calculation to prevent the training strategy from deviating too far from the initial strategy.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cal_old_log_probs_values">cal_old_log_probs_values<a href="#cal_old_log_probs_values" class="hash-link" aria-label="Direct link to cal_old_log_probs_values" title="Direct link to cal_old_log_probs_values">​</a></h4><p>Calculate the log probabilities (old policy probabilities) and value function estimates of the current training model for rollout data, which is a key step in the PPO algorithm for calculating the importance sampling ratio. actor_train.compute_log_probs uses the current training model to calculate the log probabilities of rollout data. critic.compute_values, if using GAE, simultaneously calculates the state value function.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipeline_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adv_estimator </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gae&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">critic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blocking</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actor_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_log_probs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blocking</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="adv">adv<a href="#adv" class="hash-link" aria-label="Direct link to adv" title="Direct link to adv">​</a></h4><p>The core data processing module in the RLVR training pipeline, mainly responsible for preprocessing the response data generated by the model before reinforcement learning training. The code first assigns unique identifiers to each sample and groups them by task domain, then performs four key steps for each domain&#x27;s data: (1) <code>get_sample_level_mask</code> applies sample-level mask strategies to filter unsuitable samples; (2) <code>reward_postprocess</code> post-processes and normalizes reward signals; (3) <code>compute_token_reward</code> assigns response-level rewards to token level and combines with KL divergence control to prevent excessive model deviation; (4) <code>compute_advantage</code> calculates advantage function values using GAE or other methods for PPO algorithm policy updates. Finally, <code>DataProto.concat</code> merges all domain processing results and restores the original order. This domain-grouping design allows different task types (such as mathematical reasoning, code generation, etc.) to use their most suitable processing strategies, thereby improving the training effectiveness and stability of multi-domain reinforcement learning. The entire process also includes detailed performance monitoring and metrics collection to ensure the observability of the training process.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="step_train">step_train<a href="#step_train" class="hash-link" aria-label="Direct link to step_train" title="Direct link to step_train">​</a></h4><p>The model training execution phase in the RLVR training pipeline, responsible for coordinating the parameter update process of Actor-Critic networks. Implements a critic warm-up mechanism - only starts updating the actor network when the training step count exceeds the warm-up threshold, designed to let the critic first stabilize learning the value function before policy updates. The entire training process uses the Ray framework for distributed asynchronous execution to improve efficiency, while monitoring training time through timers, and collecting training metrics (such as loss values, gradient norms, etc.) from both networks to add to the monitoring system.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipeline_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adv_estimator </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gae&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">critic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train_step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blocking</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> actor_train_timer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Critic warm-up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipeline_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">critic_warmup </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> global_step</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Update actor network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actor_train_metrics_refs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actor_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">train_step</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blocking</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="do_checkpoint">do_checkpoint<a href="#do_checkpoint" class="hash-link" aria-label="Direct link to do_checkpoint" title="Direct link to do_checkpoint">​</a></h4><p>Save checkpoints</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trackerlog">tracker.log<a href="#trackerlog" class="hash-link" aria-label="Direct link to tracker.log" title="Direct link to tracker.log">​</a></h4><p>Generate text sample logs</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">val</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Initialize validation metrics manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 1. Validation data generation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Create empty batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token plain"> validation generation configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Start inference server </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">actor_infer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Load reward cluster state </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">all</span><span class="token plain"> reward_clusters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 2. Validation environment rollout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Validation scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_batch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entire validation dataset size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 3. Clean up inference resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Stop inference server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Unload reward cluster state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 4. Calculate validation metrics</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Calculate overall accuracy </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proportion of scores </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Record </span><span class="token keyword" style="color:#00009f">global</span><span class="token plain"> validation metrics </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_correct</span><span class="token operator" style="color:#393A34">/</span><span class="token builtin">all</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 5. Group statistics by tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    grouped_batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> batch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group_by</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tag&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> group_batch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> grouped_batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Calculate accuracy </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> this tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Record grouped validation metrics </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_correct</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">tag</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Print grouped results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 6. Return validation results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Validation metrics dictionary</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The val function is the validation evaluation function in the RLVR pipeline, mainly responsible for periodically evaluating model performance on the validation set during training. The val function first starts the inference server and loads the reward model state, then performs batch generation and scoring on the entire validation dataset through the validation scheduler, calculates overall validation accuracy (by judging whether scores equal 1), groups validation data by different tags to statistically calculate average accuracy for each group, and finally returns a result dictionary containing overall and grouped validation metrics, providing quantitative evaluation of model performance for the training process, helping monitor training effectiveness and adjust training strategies.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/alibaba/ROLL/tree/main/docs_roll/docs/English/DesignImplementation/RLVRPipeline.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-10-25T09:58:13.000Z">Oct 25, 2025</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ROLL/docs/English/DesignImplementation/AgenticPipeline"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">AgenticPipeline</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ROLL/docs/English/DevelopmentGuide/support_new_models_en"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How to Add Support for a New Model</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#core-advantages" class="table-of-contents__link toc-highlight">Core Advantages</a></li><li><a href="#main-attributes" class="table-of-contents__link toc-highlight">Main Attributes</a></li><li><a href="#core-process" class="table-of-contents__link toc-highlight">Core Process</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Examples</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/ROLL/docs/简体中文/快速开始/single_node_quick_start_cn">ROLL单机实践手册</a></li><li class="footer__item"><a class="footer__link-item" href="/ROLL/docs/简体中文/快速开始/config_guide_cn">配置指南</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/alibaba/ROLL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Alibaba.</div></div></div></footer></div>
<script src="/ROLL/assets/js/runtime~main.9ad68e1a.js"></script>
<script src="/ROLL/assets/js/main.8457def1.js"></script>
</body>
</html>